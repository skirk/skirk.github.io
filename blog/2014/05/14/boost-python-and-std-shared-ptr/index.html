
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>boost python and std::shared_ptr - Tuomo's corner</title>
	<meta name="author" content="Tuomo Rinne">

	
	<meta name="description" content="Today I spent some time looking into how to wrap up the C++ standard library shared pointers in boost python.
The problem: If there is a factory &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Tuomo's corner" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--  -->
<link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic' rel='stylesheet' type='text/css'>
<!-- Load jQuery -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
	jQuery.noConflict(); // ender.js conflicts with jQuery
</script>
<!-- Load FancyBox -->
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" />
<script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
<!-- Fix FancyBox style for OctoPress -->
<style type="text/css">
  .fancybox-wrap { position: fixed !important; }
  .fancybox-opened {
    -webkit-border-radius: 4px !important;
       -moz-border-radius: 4px !important;
            border-radius: 4px !important;
  }
  .fancybox-close, .fancybox-prev span, .fancybox-next span {
    background-color: transparent !important;
    border: 0 !important;
  }
</style>

<!-- Custom Scripts -->
<script language="Javascript" type="text/javascript">
	// ender.js gobbles jQuery's ready event: Use ender.js $ instead
	$(document).ready(function() {
		jQuery(".fancybox").fancybox();
	});
</script> 

</head>

<body>
	<div class="container">	

		<div class="mid-col-container">
			<div id="content" class="inner">
				<div class="center"><a href="/"><img src="/images/loading_pacman2.gif"></a><a href="/about">&#8226 About </a><a href="/blog/archives">&#8226 Archive </a><a href="/contact">&#8226 Contact</a></div>
				<article class="post">
	<h1 class="title">Boost Python and Std::shared_ptr</h1>
	<div class="entry-content"><p>Today I spent some time looking into how to wrap up the C++ standard library shared pointers in boost python.
The problem: If there is a factory method that returns a shared pointer to an object, how to deal with the ownership when the shared_ptr needs to be converted to python object.</p>

<p>Here&rsquo;s the implementation for boost::shared_ptr</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">namespace</span> <span class="n">boost</span> <span class="p">{</span> <span class="k">namespace</span> <span class="n">python</span> <span class="p">{</span> <span class="k">namespace</span> <span class="n">converter</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">PyObject</span><span class="o">*</span> <span class="n">shared_ptr_to_python</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">python</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">none</span><span class="p">();</span>
</span><span class='line'>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shared_ptr_deleter</span><span class="o">*</span> <span class="n">d</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">get_deleter</span><span class="o">&lt;</span><span class="n">shared_ptr_deleter</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">incref</span><span class="p">(</span> <span class="n">get_pointer</span><span class="p">(</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="p">)</span> <span class="p">);</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">converter</span><span class="o">::</span><span class="n">registered</span><span class="o">&lt;</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;&gt;::</span><span class="n">converters</span><span class="p">.</span><span class="n">to_python</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}}}</span> <span class="c1">// namespace boost::python::converter</span>
</span></code></pre></td></tr></table></div></figure>


<p>The line <em>11</em> is the crown jewel. Unfortunately, currently there is no way to transfer Standard Template Library shared pointers in such way. Therefore, unless one is willing to add the same functionality for the STL version, they are a no go. In my work I decided to go change my pointers to boost equivalents because of this. Ah, the laziness.</p>
</div>

</article>


			</div>
		</div>
		<footer id="footer" class="inner">
		Copyright &copy; 2014 

    <a href="/about">Tuomo Rinne</a>
 |
<span class="credit">Powered by <a href="http://octopress.org">Octopress</a>, customized with <a href="https://github.com/mjhea0/nologo">noLogo</a> + my own hacks</span>
</footer>
		<script src="/javascripts/slash.js"></script>








	</div>
</body>
</html>
